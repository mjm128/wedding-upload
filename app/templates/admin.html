<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container" style="max-width: 1000px; margin: 0 auto; padding: 20px;">
        <div class="glass-card">
            <h1>Admin Dashboard</h1>

            <div id="stats" style="margin-bottom: 20px;">
                Loading stats...
            </div>

            <div style="margin-bottom: 20px;">
                <h3>Global Banner</h3>
                <input type="text" id="banner-input" placeholder="Enter message..." style="padding: 10px; width: 70%;">
                <button class="btn" onclick="setBanner()">Set Banner</button>
                <button class="btn btn-secondary" onclick="setBanner('')">Clear</button>
            </div>
        </div>

        <div class="glass-card">
            <h2>Media Moderation</h2>
            <div id="media-grid" class="masonry-grid">
                <!-- Loaded via JS -->
            </div>
            <button class="btn" onclick="loadMedia()">Load More</button>
        </div>
    </div>

    <script>
        // Fetch Stats
        fetch('/admin/stats').then(r => r.json()).then(data => {
            document.getElementById('stats').innerHTML = `
                <strong>Storage:</strong> ${data.disk_used_gb}GB / ${data.disk_total_gb}GB (Free: ${data.disk_free_gb}GB)<br>
                <strong>Total Media:</strong> ${data.media_count}
            `;
        });

        // Banner
        async function setBanner(msg) {
            const val = msg !== undefined ? msg : document.getElementById('banner-input').value;
            const formData = new FormData();
            formData.append('message', val);
            await fetch('/admin/banner', { method: 'POST', body: formData });
            alert('Banner updated');
        }

        // Media
        let cursor = null;
        async function loadMedia() {
            let url = '/slideshow/feed?limit=20';
            if (cursor) url += '&cursor=' + cursor;

            const res = await fetch(url);
            const data = await res.json();

            const grid = document.getElementById('media-grid');

            data.items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'grid-item';
                div.innerHTML = `
                    <div class="glass-card" style="padding: 10px;">
                        ${item.type === 'video' ? '<span style="color:gold">[VIDEO]</span>' : ''}
                        <img src="${item.thumbnail || item.url}" class="media-content ${item.is_hidden ? 'hidden-media' : ''} ${item.is_starred ? 'starred-media' : ''}" loading="lazy">
                        <p>${item.author || 'Guest'}: ${item.caption || ''}</p>
                        <div style="display: flex; gap: 5px;">
                            <button class="btn-secondary" style="padding: 5px;" onclick="action(${item.id}, '${item.is_hidden ? 'unhide' : 'hide'}')">${item.is_hidden ? 'Unhide' : 'Hide'}</button>
                            <button class="btn-secondary" style="padding: 5px;" onclick="action(${item.id}, '${item.is_starred ? 'unstar' : 'star'}')">${item.is_starred ? 'Unstar' : 'Star'}</button>
                            <button class="btn-secondary" style="padding: 5px; color: red; border-color: red;" onclick="action(${item.id}, 'delete')">Delete</button>
                        </div>
                    </div>
                `;
                grid.appendChild(div);
            });

            if (data.items.length > 0) cursor = data.next_cursor;
        }

        async function action(id, act) {
            const fd = new FormData();
            fd.append('action', act);
            await fetch(`/admin/media/${id}/action`, { method: 'POST', body: fd });
            // Refresh
            document.getElementById('media-grid').innerHTML = '';
            cursor = null;
            loadMedia();
        }

        loadMedia();
    </script>
</body>
</html>
